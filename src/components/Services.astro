---
import {Image, type ImageMetadata} from 'astro:assets';
import service from '../data/services.json';
import {slugify} from '../utils/slugify';

// Type definitions remain the same
type ServiceImages = { main: string; }
type ServiceItem = { title: string; description: string; images: ServiceImages[]; }
type ServiceData = { title: string; description: string; data: ServiceItem[]; }

const serviceContent: ServiceData = service;

// Step 2.1: Use import.meta.glob to load all possible service images
// The <{ default: ImageMetadata }> part provides TypeScript type safety.
const allServiceImages = import.meta.glob<{ default: ImageMetadata }>(
    '/src/assets/diensten/**/*.{jpeg,jpg,png,gif,webp,avif}'
);
---
<section class="py-16 sm:py-32">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
        <div class="mx-auto max-w-2xl text-center">
            <h2 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">{serviceContent.title}</h2>
            <p class="mt-2 text-lg leading-8 text-gray-600">{serviceContent.description}</p>
        </div>
        <div class="mx-auto mt-16 grid max-w-2xl auto-rows-fr grid-cols-1 gap-8 sm:mt-20 lg:mx-0 lg:max-w-none lg:grid-cols-3">
            {serviceContent.data.map((item: ServiceItem) => {
                // Step 2.2: Get the string path from the JSON data

                const imagePath = item.images[0].main;

                // Step 2.3: Look up the corresponding image module in our glob import

                const imageModule = allServiceImages[imagePath];

                // Add a check to ensure the image exists to prevent build errors

                if (!imageModule) {
                    console.error(`Image not found for path: ${imagePath}`);
                    return null; // or render a fallback

                }

                return (
                        <div class="relative isolate flex flex-col justify-end overflow-hidden rounded-2xl bg-brand-900 px-8 pb-8 pt-80 sm:pt-48 lg:pt-80">

                            {/* Step 3: Use the <Image /> component with the resolved module */}
                            <Image
                                    src={imageModule()}
                                    alt={item.title}
                                    class="absolute inset-0 -z-10 h-full w-full object-cover"
                                    widths={[240, 540, 720, 1080]}
                                    sizes="(max-width: 640px) 90vw, (max-width: 1024px) 45vw, 30vw"
                            />

                            <div class="absolute inset-0 -z-10 bg-linear-to-t from-gray-900 via-gray-900/40"></div>
                            <div class="absolute inset-0 -z-10 rounded-2xl ring-1 ring-inset ring-gray-900/10"></div>
                            <h3 class="mt-3 text-lg font-semibold leading-6 text-white">
                                <a href={`/nl/diensten/${slugify(item.title)}`}>
                                    <span class="absolute inset-0"></span>
                                    {item.title}
                                </a>
                            </h3>
                            <p class="mt-3 font-semibold leading-6 text-white">{item.description}</p>
                        </div>
                );
            })}
        </div>
    </div>
</section>